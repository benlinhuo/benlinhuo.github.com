---
layout:     post
title:      native 和 H5 页面交互方式[JavascriptCore]
category: iOS
tags: [iOS]
description: 因为 H5 页面有自身优势，所以有时候我们常常会在 native 中调用 H5 页面，这便涉及到两者之间的交互。也有一个专有名称 -- hybird app
---

## 简介

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H5 页面，它只需要 web 端写一份代码，就可以适用安卓和 iOS 两端，效率高；同时，在业务更新或者更改 bug 时，H5 页面是可以做到实时，而native 需要发布新版本还有审核期，尤其 iOS ，如果是个很紧急的东西需要发布，那无疑 H5 是最好的解决方案。但是它在一些复杂页面的体验效果不好，所以也就有了 native 的应用。hybird app 即是一些简单页面，不影响用户体验部分使用 H5 页面，其他采用 native，这样就不可避免的存在两者间的交互，实质也就是 OC 和 JS 之间的交互。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;自从 iOS 7 之后，就引入了 JavaScriptCore 库，它把 WebKit 的 Javascript 引擎用 OC 封装，提供简单、快速、安全的方式，让两者交互。自己有用一个 demo 总结它们之间的交互，[OC 与 js 交互 Demo](https://github.com/benlinhuo/JavaScript-WebView)


##JavascriptCore

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当我们使用 JavascriptCore 时，则需要在文件开始位置 `@import JavaScriptCore;` ，进入该文件，可以看到如下代码：

```
#ifndef JavaScriptCore_h
#define JavaScriptCore_h

#include <JavaScriptCore/JavaScript.h>
#include <JavaScriptCore/JSStringRefCF.h>

#if defined(__OBJC__) && JSC_OBJC_API_ENABLED

#import "JSContext.h"
#import "JSValue.h"
#import "JSManagedValue.h"
#import "JSVirtualMachine.h"
#import "JSExport.h"

#endif

#endif /* JavaScriptCore_h */

```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可以看到其中有引入几个类。


### JSContext

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;它是 JS 代码运行时提供的上下文，用于保持 JS 中的一些变量以及方法。如果我们写一个 H5 页面，它默认是有一个 window 对象的，那此处的 JSContext 就相当于 window。如果我们创建了这个对象，也就意味着我们是可以像编写在浏览器运行的 H5 页面的 JS 代码。我们一般使用两种方式创建该对象。

#### 方式一：获取 UIWebView 对应的运行 JS 代码的上下文

`JSContext *context = [webView valueForKeyPath:@"documentView.webView.mainFrame.javaScriptContext"];` 

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这种方式获取到的 `context`，它同运行在 H5 页面 JS 执行代码环境是同一个，所以我们可以访问到 H5 页面中自定义挂靠在 window 对象的方法或者变量。也因为这样，我们可以实现 H5 页面和 native 之间的交互。两边的 JS 代码位于同一个执行环境，自然可以互通有无。

#### 方式二：跟一般类初始化一样

`JSContext *context = [[JSContext alloc] init];`

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这种就是一般创建类的方式，自然也就是仅仅创建了一个可以运行 JS 代码的环境（H5 页面中可以写的 JS 代码，理论上来说都可以在这个环境中运行）。即用 OC 写 JS 代码，则需要专门为 JS 提供运行环境。这样创建的仅仅是一个单纯的 JS 环境，你无法和 UIWebView 中运行的 JS 联系。所以这种在实际中一般就很少用到。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当我们使用 JS 定义个方法，OC 中调用，如果需要给这个方法传递参数：一种是固定的参数，第二种是动态的参数，即变量表示。动态参数通过 `callWithArguments` 传递。

```
context[@"simplifyString"] = ^(NSString *input) {
   NSLog(@"test input = %@", input);
};
[context evaluateScript:@"simplifyString('input')"]; 

// 方式一
JSValue * fn = [context objectForKeyedSubscript:@"simplifyString"];
// 方式二
JSValue *fn = context[@"simplifyString"];
JSValue *result = [fn callWithArguments:@[@"testArguments"]];
```

### JSValue

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JS 是动态语言，它的类型和 OC 不同，所以两者之间要想通用一些数据类型，便使用了 JavaScriptCore 中的 JSValue 来作为中间类型。

`JSValue *num = [context evaluateScript:@"var num = 5 + 5"];` 任何通过 JSContext 获取的值都是被包裹在一个 JSValue 对象中的。JSValue 中包含一系列方法用于访问其可能的值以保证有正确的 Foundation 类型，如下表格是类型的对应关系：

JavaScript Type | JSValue method | Objective-C Type | Swift Type
-------|------|------|------
string | toString | NSString | String!
boolean | toBool | BOOL | Bool
number | toNumber / toDouble / toInt32 / toUInt32 | NSNumber / double     / int32_t     / uint32_t | NSNumber! / Double / Int32 / UInt32
Date | toDate | NSDate | NSDate!
Array | toArray | NSArray | [AnyObject]!
Object | toDictionary | NSDictionary | [NSObject : AnyObject]!
Object | toObject / toObjectOfClass:	 | custom type | custom type

如下实例：

```
JSContext *context = [[JSContext alloc] init];
[context evaluateScript:@"var num = 5;"];
[context evaluateScript:@"var names = ['Lucy', 'LiMei', 'John'];"];

NSLog(@"num = %d", [context[@"num"] toInt32]);
// 对于数组，我们可以使用下标获取
JSValue *names = context[@"names"];
JSValue *firstName = names[0];
NSLog(@"first name = %@", [firstName toString]);

```

### JSManagedValue

### JSVirtualMachine

### JSExport



##交互方式



### JS 调用 OC
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果想要我们的 js 调用到 OC 中定义的方法或者变量，有如下方式：第1和2种方式，都是利用 JavascriptCore 提供的 API 实现，第3种方式，其实就是跟 JavascriptCore 没有任何关系，通过在 OC 中监控 URL 跳转来获取参数并判断是否继续加载当前页面。

#### 1. 通过 block 方式

#### 2. 使用 JSExport 协议

#### 3. 监控 URL 跳转

### OC 调用 JS 





参考资料：

[http://nshipster.cn/javascriptcore/](http://nshipster.cn/javascriptcore/)
