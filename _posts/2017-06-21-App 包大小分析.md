---
layout:     post
title:      App 包大小分析
category: iOS
tags: [iOS]
description: 随着项目的开发时间越长，会发现包也是越来越大，这样用户从 AppStore 上下载所需耗费流量也就越多。本期主题便是如何给包瘦身。
---

## 包瘦身简介

一年前刚来公司的时候，App 包大小大概在30M左右，现在已经有60M，所以包瘦身迫不及待。总结下，一般会从如下几个方面着手考虑。 

![瘦身法则](/assets/images/slimming-summary.jpg)

### 资源优化

最常见的资源，就是图片，一般还有视频、音频（也只能通过压缩来减少大小）等。先来说说图片的优化：

1. 删除无用的图片(包括没用以及重复的图片)

	很有用的一个工具 [LSUnusedResources.app.zip](https://github.com/tinymind/LSUnusedResources/raw/master/Release/LSUnusedResources.app.zip) 或者对应的该工具的 [项目代码](https://github.com/tinymind/LSUnusedResources/)。它是使用脚本来匹配查找项目中的图片有哪些未在项目代码中使用。
	
	![LSUnusedResources使用](/assets/images/LSUnusedResourcesExample.gif)
	
	使用这个工具，大部分未使用的图片已经可以查找到，但是也有一些例外的情况，如重复的图片（Images.xcassets 中位于不同文件夹下名字相同或者图片内容相同但是命名不同）、Images.xcassets 中命名和图片本身名字不相同的图片、一些拼接名字来使用的图片要注意手动剔除（LSUnusedResources 是全匹配，所以这些图片它会认为它是未使用，要谨慎）。这些特殊情况比较少，但是需要手动去解决，或者自己写个脚本去处理。
	
	![名字相同的重复图片](/assets/images/images-xcassets-same.jpg) 
	
	![Images.xcassets 中命名和图片本身名字不相同的图片](/assets/images/diff-name-one-pic.jpg)   


2. 图片压缩

	图片压缩一般分为无损和有损。
	
	无损压缩常用的工具是 [ImageOptim](https://imageoptim.com)。它是一款基于Mac的图像“瘦身”软件，内置多种压缩算法，通过删除图片部分无用的EXIF等信息来减小PNG、JPEG和GIF图片的大小。你可以直接把文件夹拖入进行压缩，它压缩完成会自动帮忙替换图片文件，命名不变化，同时源文件会被删除，要注意。
	
	有损压缩常用工具是 [TinyPNG](https://tinypng.com)，直接网页拖入对应图片即可，这种一般比较适合颜色不鲜明，图片比较大的图片，意思是稍微损失一点也不会影响人类肉眼对图片的观感，但是要注意如果我们iPhone 6 Plus(需要使用@3x图片，但是我们为了节省只使用了 @2x，则这个有损压缩的图片需要注意了，防止在Plus手机上显示模糊)。

3. 删除@1x图片，部分@3x图片也也可以删除

	![iPhone 分辨率对比](/assets/images/ratio-iphones.jpg) 
	
	看上图可知，@1x 时代的机器基本已经淘汰了，所以现在根本不需要提供@1x的图片，所以可以完全删除。相对来说，@3x图的使用只有Plus的手机才会用到，但是适配@3x的手机使用@2x的图，一般来说肉眼也不太能看出区别，所以在对图片色彩这方面要求不高的App，就可以为了减少包大小，不使用 @3x 图。

4. Assets.xcassets

	图片的导入方式有如下几种：
	
	* 加入到Assets.xcassets中: 
	
		1> 只支持png格式的图片；
		
		2> 图片只支持[UIImage imageNamed]的方式实例化，但是不能从Bundle中加载；
		
		3> 在编译时，Images.xcassets中的所有文件会被打包为Assets.car的文件

	* CreateGroup

		1> 黄色文件夹图标；Xcode中分文件夹，Bundle中所有所在都在同一个文件夹下，因此，不能出现文件重名的情况
		
		2> 可以直接使用[NSBundle mainBundle]作为资源路径，效率高！
		
		3> 可以使用[UIImage imageNamed:]加载图像
	
	* CreateFolderRefences
	
		1> 蓝色文件夹；Xcode中分文件夹，Bundle中同样分文件夹，因此，可以出现文件重名的情况
		
		2> 需要在[NSBundle mainBundle]的基础上拼接实际的路径，效率较差
		
		3> 不能使用[UIImage imageNamed:]加载图
	
	* PDFs矢量图（Xcode6+）
	
		iOS 支持矢量图做成的PDF。但注意，PDF是有个初始大小的，iOS在把PDF转为图片时是根据这个大小信息来生成1倍/2倍/3倍大小的图片，而不支持我们自己无失真放大。实际上Xcode6下使用PDF只是在`编译`时根据PDF生成不同倍数图片，并不在应用中使用矢量图。所以在使用PDF作为矢量图想要减小包大小，效果不明显。

	
	* Bundle（包）中的图片素材

	把一些静态资源文件放到Bundle中，其实对于包大小没有影响。因为.bundle包在项目中多大，在打包之后.app中就还是多大，且以.bundle存在。只是在打包之后存在于.app中比较整齐，如解压支付宝的.ipa包，如下图：
	
	![支付宝都以.bundle包装](/assets/images/alipay-ipa.jpg) 
	
	
	经过测试得知：CreateGroup、CreateFolderRefences两种方式打出来的包，图片都会直接放在.app文件中，所以打包前后，图片的大小不会改变。而加入到Assets.xcassets中的方法则不同，打包后，在.app中会生成Assets.car文件来存储Assets.xcassets中的图片，并且文件大小方面也大大降低。所以，使用Assets.xcassets来管理图片也可以达到ipa瘦身的效果。
	
	<table>
    <tr>
        <td>打包前Assets.xcassets文件夹</td>
        <td>打包后的Assets.car文件夹</td>
    </tr>
    <tr>
        <td>32.7MB</td>
        <td>24.3MB</td>
    </tr>
</table>

5. H5页面远端化
	
	如果本地的一些H5方面的静态资源比较多，考虑业务体验的情况下部分远端话，如二级页面或者一些更深级别的页面，可以在App启动的时候下载即可。


6. 一些简单的图形，比如圆角等，直接使用代码实现即可，减少图片的使用

7. iconfont

	iconfont 其实最早是使用在 Web 开发中，它提供的是矢量图，可以无视真的缩放，且可以自己设置颜色，所以它的好处很明显。目前我们项目中使用了挺多只是颜色不同的图片（如选中、未选中），还有大小或者颜色不同的图片（各种箭头）。在iOS中使用字体的后缀一般是.ttf。
	
	优点：
	
	* 减小体积，字体文件比图片要小
	* 图标保真缩放，解决2x/3x乃至将来的nx图问题
	* 方便更改颜色大小，图片复用

	缺点：
	
	* 只适用于 `纯色icon`
	* 使用unicode字符难以理解
	* 需要维护字体库

	效果分析（数据来自于网上）：
	
	1> 体积减小效果
	
	对项目的图片做了一些替换，目前替换了69张2x图，同时减少67张3x图。为了计算这些图片打包后实际所占体积，我们建立了一个空工程，通过执行Archive、Estimated App Store Size来查看体积。在工程中放入2x或3x图片后再次计算。(单位KB)

	<table>
	    <tr>
	        <td>资源</td>
	        <td>空工程</td>
	        <td>2x图</td>
	        <td>3x图</td>
	        <td>字体</td>
	    </tr>
	    <tr>
	        <td>工程体积</td>
	        <td> 195 </td>
	        <td> 249 </td>
	        <td> 268 </td>
	        <td> 214 </td>
	    </tr>
	    <tr>
	        <td>资源体积</td>
	        <td> 0 </td>
	        <td> 54 </td>
	        <td> 73 </td>
	        <td> 19 </td>
	    </tr>
	</table>
	
	目前看来替换这部分图片后，仅考虑2x图则替换后体积是之前的35%，如果算上3x图则体积是之前的15%！
	
	2> 生成图片的性能
	
	对比了字体生成图片和直接使用PNG图片的效率。图片选择了32、64、200三种尺寸的2倍图。统计了两种方法创建1000次UIImageView的耗时，平台为iPhone 5S/iOS8。结果如下（单位：秒）：
	
	<table>
    <tr>
        <td>方法\尺寸</td>
        <td> 32 </td>
        <td> 64 </td>
        <td> 200 </td>
    </tr>
    <tr>
        <td>字体生成图片</td>
        <td> 0.426 </td>
        <td> 0.476 </td>
        <td> 2.085 </td>
    </tr>
    <tr>
        <td>PNG图片</td>
        <td> 0.454 </td>
        <td> 0.441 </td>
        <td> 0.467 </td>
    </tr>
</table>

	
	PNG图片加载的速度受像素大小影响很小。字体生成图片的方式在32像素的2倍图中，字体生成图片的速度甚至比加载PNG图片还要快。最坏的情况是生成1000张200像素的2倍图耗时达到了2秒多。但是这种情况比较极端，即使有多张大图展示的需求，也可以通过UITableView来做懒加载。而且平均下来每张图耗时2毫秒。总体来看字体生成图片效率还可以接受。










































