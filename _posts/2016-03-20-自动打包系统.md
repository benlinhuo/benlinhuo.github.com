---
layout:     post
title:      自动打包系统
category: iOS, PHP
tags: [iOS, PHP]
description: 该系统，可以自动完成我们 iOS 项目的打包
---

## 背景介绍
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当你正紧张兮兮的改着 bug，QA 或者产品让帮忙打个包测试，你打断自己的工作打个包回来，可能之前的思路就被打断了，主要是我们打包还不能在当前开发分支上打包，来回切换代码，也是很苦逼的事儿。为此，我们一定要想个办法，把这个需求推给提出方，让他们自己去完成自己需求。于是便有了自动打包系统。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个自动打包系统分为两部分，一个是根据我每次提交代码，都会自动打一次包；还有就是网页上，QA 点击打包按钮，主动去打包。这个项目的 Git 地址：[github 地址](https://github.com/benlinhuo/AutoPackageSystem.git)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个项目，后台是用 PHP 做为开发语言，laravel 做为开发框架（因为当时我们的后台 PHP 框架用的就是这个，这样在遇到问题的时候可以方便得到解决），其中集成了 iOS 的打包脚本（shell 脚本写的）和 安卓 的打包脚本（python 写的），当然我们也可以集成如其他语言的打包脚本，因为脚本做的事情就只是一个任务，只要通过 php 通知到系统进行打包，就可以将这个指令丢给打包脚本完成，就哦啦。

## 简单的类图

## iOS 打包脚本
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iOS 打包脚本的语言是 shell，这是真正执行任务的“功臣”。它的核心代码如下：

```
#clean
    xcodebuild -workspace Angejia.xcworkspace -scheme Angejia -configuration Release CODE_SIGN_IDENTITY="${sign}" PROVISIONING_PROFILE="${provisioning}" OBJROOT="${parentDir}" SYMROOT=${parentDir} clean

    #build
    xcodebuild -workspace Angejia.xcworkspace -scheme Angejia -configuration Release CODE_SIGN_IDENTITY="${sign}" PROVISIONING_PROFILE="${provisioning}" OBJROOT="${parentDir}" SYMROOT=${parentDir}
    

    #xcrun路径需要绝对路径
    xcrun -sdk iphoneos PackageApplication -v $parentDir/Release-iphoneos/Angejia.app -o $parentDir/Angejia.ipa

```

* 第一步是清理（clean），清理的目的是保证打的包是干净的，而且打包过程不容易出奇葩问题。
* 第二步是编译（xcodebuild），他们通过参数指定需要打的包是 Release 还是 Debug，打包的证书等。
* 第三步就是打包（xcrun），-o 指定了输出路径，将 app 后缀文件打包成 ipa。其实这步的原理就是在编译之后，将

## 待改进点
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个系统已经基本满足了我们的需求。不过，它还有一个比较大的缺陷：打包脚本任务执行的结果没有办法反馈给 php 系统，从而告知用户。对于自动打包部分，寻找任务执行结果可能比较难些，脚本任务会被添加到队列中，然后按照队列执行顺序执行，这样就是完全异步的，我还没找到二者之间通信的好办法。如果对于网站打包，其实在用户看来就是一个同步的过程，php 使用执行外部程序的方法是 exec("command", $res, $err); ，$res 表示每行执行结果组成的数组，$err表示执行状态，至于这个执行状态成功与否也需要在脚本中判断。


